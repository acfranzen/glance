{
  "version": 1,
  "type": "glance-widget",
  "meta": {
    "name": "Claude Max Usage",
    "slug": "claude-max-usage",
    "description": "Displays Claude Max subscription usage limits - session, weekly, and extra usage tracked from the Claude CLI",
    "author": "zeus@openclaw",
    "created_at": "2026-02-03T16:00:00.000Z",
    "exported_at": "2026-02-03T16:00:00.000Z"
  },
  "widget": {
    "source_code": "function Widget() {\n  const { data, loading, error, refresh } = useData('claude', {});\n\n  const getProgressColor = (percent) => {\n    if (percent > 90) return 'bg-red-500';\n    if (percent > 75) return 'bg-amber-500';\n    if (percent > 50) return 'bg-blue-500';\n    return 'bg-emerald-500';\n  };\n\n  const getProgressVariant = (percent) => {\n    if (percent > 90) return 'error';\n    if (percent > 75) return 'warning';\n    return 'default';\n  };\n\n  const formatTimestamp = (isoString) => {\n    try {\n      const date = new Date(isoString);\n      const now = new Date();\n      const diffMs = now.getTime() - date.getTime();\n      const diffMins = Math.floor(diffMs / 60000);\n\n      if (diffMins < 1) return 'just now';\n      if (diffMins < 60) return `${diffMins}m ago`;\n\n      const diffHours = Math.floor(diffMins / 60);\n      if (diffHours < 24) return `${diffHours}h ago`;\n\n      return date.toLocaleDateString();\n    } catch {\n      return 'unknown';\n    }\n  };\n\n  if (loading) {\n    return (\n      <Card className=\"h-full\">\n        <CardContent className=\"flex items-center justify-center h-full\">\n          <Loading message=\"Loading usage...\" />\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (error && !data?.capturedAt) {\n    return (\n      <Card className=\"h-full\">\n        <CardContent className=\"flex flex-col items-center justify-center h-full gap-3 p-4\">\n          <Icons.AlertCircle className=\"w-8 h-8 text-amber-500\" />\n          <div className=\"text-sm text-center text-muted-foreground\">\n            {error.message || data?.error || 'Failed to load usage data'}\n          </div>\n          <button\n            onClick={refresh}\n            className=\"text-xs text-primary hover:underline flex items-center gap-1\"\n          >\n            <Icons.RefreshCw className=\"w-3 h-3\" /> Retry\n          </button>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (!data) {\n    return (\n      <Card className=\"h-full\">\n        <CardContent className=\"flex items-center justify-center h-full\">\n          <span className=\"text-sm text-muted-foreground\">No data available</span>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"h-full flex flex-col\">\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Icons.Zap className=\"w-4 h-4 text-blue-500\" />\n            <CardTitle className=\"text-sm\">Claude Max</CardTitle>\n            {data.isDemo && (\n              <Badge variant=\"info\">DEMO</Badge>\n            )}\n          </div>\n          <button\n            onClick={refresh}\n            className=\"text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            <Icons.RefreshCw className=\"w-3 h-3\" />\n          </button>\n        </div>\n      </CardHeader>\n      <CardContent className=\"flex-1 overflow-y-auto pt-0 space-y-4\">\n        {/* Session usage */}\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-1\">\n              <Icons.Clock className=\"w-3 h-3 text-muted-foreground\" />\n              <span className=\"text-xs text-muted-foreground\">Current Session</span>\n            </div>\n            <span className=\"text-xs font-semibold text-foreground\">\n              {data.session?.percentUsed || 0}%\n            </span>\n          </div>\n          <Progress value={data.session?.percentUsed || 0} variant={getProgressVariant(data.session?.percentUsed || 0)} size=\"sm\" />\n          {data.session?.resetsAt && (\n            <div className=\"text-[10px] text-muted-foreground\">\n              Resets at {data.session.resetsAt}\n            </div>\n          )}\n        </div>\n\n        {/* Weekly (all models) usage */}\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Week (All Models)</span>\n            <span className=\"text-xs font-semibold text-foreground\">\n              {data.weekAll?.percentUsed || 0}%\n            </span>\n          </div>\n          <Progress value={data.weekAll?.percentUsed || 0} variant={getProgressVariant(data.weekAll?.percentUsed || 0)} size=\"sm\" />\n          {data.weekAll?.resetsAt && (\n            <div className=\"text-[10px] text-muted-foreground\">\n              Resets {data.weekAll.resetsAt}\n            </div>\n          )}\n        </div>\n\n        {/* Weekly (Sonnet) usage */}\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Week (Sonnet)</span>\n            <span className=\"text-xs font-semibold text-foreground\">\n              {data.weekSonnet?.percentUsed || 0}%\n            </span>\n          </div>\n          <Progress value={data.weekSonnet?.percentUsed || 0} variant={getProgressVariant(data.weekSonnet?.percentUsed || 0)} size=\"sm\" />\n          {data.weekSonnet?.resetsAt && (\n            <div className=\"text-[10px] text-muted-foreground\">\n              Resets {data.weekSonnet.resetsAt}\n            </div>\n          )}\n        </div>\n\n        {/* Extra usage */}\n        {data.extra && (\n          <div className=\"space-y-1 pt-2 border-t border-border/50\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-1\">\n                <span className=\"text-xs text-muted-foreground\">Extra Usage</span>\n              </div>\n              <span className=\"text-xs font-semibold text-foreground\">\n                {data.extra.percentUsed}%\n              </span>\n            </div>\n            <Progress value={data.extra.percentUsed} variant={getProgressVariant(data.extra.percentUsed)} size=\"sm\" />\n            <div className=\"text-[10px] text-muted-foreground\">\n              {data.extra?.spent || \"—\"} · Resets {data.extra.resetsAt}\n            </div>\n          </div>\n        )}\n      </CardContent>\n\n      {/* Last updated timestamp */}\n      <div className=\"text-[10px] text-muted-foreground/60 text-center p-2\">\n        Updated {formatTimestamp(data.capturedAt)}\n      </div>\n    </Card>\n  );\n}",
    "server_code": "// Read Claude usage data from cache file\n// The cache is populated by OpenClaw via PTY capture of the Claude CLI\nconst CACHE_PATH = '/tmp/claude-usage-cache.json';\n\nconst cacheContent = await readCacheFile(CACHE_PATH);\n\nif (!cacheContent) {\n  return {\n    session: { percentUsed: 0, resetsAt: 'No data' },\n    weekAll: { percentUsed: 0, resetsAt: 'No data' },\n    weekSonnet: { percentUsed: 0, resetsAt: 'No data' },\n    capturedAt: new Date().toISOString(),\n    lastUpdated: new Date().toISOString(),\n    error: 'No usage data. Ask OpenClaw to capture Claude usage.'\n  };\n}\n\ntry {\n  const data = JSON.parse(cacheContent);\n  \n  // Check cache age\n  const cacheAge = Date.now() - new Date(data.capturedAt).getTime();\n  const isStale = cacheAge > 5 * 60 * 1000; // 5 minutes\n  \n  return {\n    session: data.session || { percentUsed: 0, resetsAt: 'Unknown' },\n    weekAll: data.weekAll || { percentUsed: 0, resetsAt: 'Unknown' },\n    weekSonnet: data.weekSonnet || data.weekOpus || { percentUsed: 0, resetsAt: 'Unknown' },\n    extra: data.extra,\n    capturedAt: data.capturedAt,\n    lastUpdated: new Date().toISOString(),\n    fromCache: true,\n    staleCache: isStale\n  };\n} catch (err) {\n  return {\n    session: { percentUsed: 0, resetsAt: 'Error' },\n    weekAll: { percentUsed: 0, resetsAt: 'Error' },\n    weekSonnet: { percentUsed: 0, resetsAt: 'Error' },\n    capturedAt: new Date().toISOString(),\n    lastUpdated: new Date().toISOString(),\n    error: 'Failed to parse cached usage data'\n  };\n}",
    "server_code_enabled": true,
    "default_size": {
      "w": 1,
      "h": 2
    },
    "min_size": {
      "w": 1,
      "h": 1
    },
    "refresh_interval": 30
  },
  "credentials": [
    {
      "id": "claude-cli",
      "type": "local_software",
      "name": "Claude CLI",
      "description": "The official Claude CLI from Anthropic. Must be installed and authenticated with an active Claude Max subscription.",
      "check_command": "which claude && claude --version 2>/dev/null",
      "install_url": "https://claude.ai/download",
      "install_instructions": "1. Download Claude CLI from https://claude.ai/download\n2. Install: brew install claude (macOS) or follow platform-specific instructions\n3. Authenticate: claude login\n4. Verify: claude --version"
    }
  ],
  "setup": {
    "description": "Configure OpenClaw to capture Claude usage data via PTY",
    "agent_skill": "## Claude Max Usage Capture Setup\n\nThe Claude CLI requires a TTY to display usage information. This widget needs OpenClaw to periodically capture the usage data and write it to a cache file.\n\n### Why PTY Capture?\n\nThe Claude CLI displays usage bars on startup ONLY when connected to a terminal (TTY). Running `claude` in a non-interactive script won't show usage data. You need to:\n\n1. Launch Claude CLI in a PTY (pseudo-terminal)\n2. Capture the initial output showing usage bars\n3. Parse the usage percentages\n4. Write to the cache file\n5. Exit Claude cleanly\n\n### Agent Task: Capture Claude Usage\n\nAdd to your heartbeat (every 5-15 minutes) or use a cron job:\n\n```python\nimport pty\nimport os\nimport re\nimport json\nfrom datetime import datetime\n\ndef capture_claude_usage():\n    output = []\n    \n    def read_output(fd):\n        data = os.read(fd, 1024)\n        output.append(data.decode('utf-8', errors='replace'))\n        return data\n    \n    # Run claude in PTY - it will show usage on startup\n    # Send Ctrl+C after brief delay to exit\n    pid, fd = pty.fork()\n    if pid == 0:\n        os.execlp('claude', 'claude', '--dangerously-skip-permissions')\n    else:\n        import select\n        import time\n        start = time.time()\n        while time.time() - start < 5:  # 5 second timeout\n            r, _, _ = select.select([fd], [], [], 0.1)\n            if r:\n                try:\n                    data = os.read(fd, 4096)\n                    if data:\n                        output.append(data.decode('utf-8', errors='replace'))\n                except OSError:\n                    break\n            full_output = ''.join(output)\n            # Check if we got the usage bars\n            if 'Current session' in full_output and 'Week' in full_output:\n                break\n        \n        # Send Ctrl+C to exit\n        os.write(fd, b'\\x03')\n        os.waitpid(pid, 0)\n    \n    return ''.join(output)\n\ndef parse_usage(output):\n    data = {\n        'session': {'percentUsed': 0, 'resetsAt': 'Unknown'},\n        'weekAll': {'percentUsed': 0, 'resetsAt': 'Unknown'},\n        'weekSonnet': {'percentUsed': 0, 'resetsAt': 'Unknown'},\n        'capturedAt': datetime.now().isoformat(),\n    }\n    \n    # Parse: \"Current session   ████░░░░░░  42% · Resets at 5:00 PM EST\"\n    session = re.search(r'Current session\\s+[█░]+\\s+(\\d+)%\\s*·\\s*Resets at (.+?)(?:\\n|$)', output)\n    if session:\n        data['session'] = {'percentUsed': int(session.group(1)), 'resetsAt': session.group(2).strip()}\n    \n    # Parse: \"Week (all models) ████░░░░░░  38% · Resets Monday 2/3\"\n    week_all = re.search(r'Week \\(all models\\)\\s+[█░]+\\s+(\\d+)%\\s*·\\s*Resets (.+?)(?:\\n|$)', output)\n    if week_all:\n        data['weekAll'] = {'percentUsed': int(week_all.group(1)), 'resetsAt': week_all.group(2).strip()}\n    \n    # Parse: \"Week (Sonnet)     ████░░░░░░  12% · Resets Thursday 2/6\"\n    week_sonnet = re.search(r'Week \\((?:Sonnet|Opus)\\)\\s+[█░]+\\s+(\\d+)%\\s*·\\s*Resets (.+?)(?:\\n|$)', output)\n    if week_sonnet:\n        data['weekSonnet'] = {'percentUsed': int(week_sonnet.group(1)), 'resetsAt': week_sonnet.group(2).strip()}\n    \n    # Parse extra usage if present\n    extra = re.search(r'Extra usage[\\s\\S]+?(\\d+)%[\\s\\S]+?\\$?([\\d.]+)\\s*/\\s*\\$?([\\d.]+)\\s+spent\\s*·\\s*Resets (.+?)(?:\\n|$)', output)\n    if extra:\n        data['extra'] = {\n            'percentUsed': int(extra.group(1)),\n            'spent': float(extra.group(2)),\n            'limit': float(extra.group(3)),\n            'resetsAt': extra.group(4).strip()\n        }\n    \n    return data\n\n# Capture and save\noutput = capture_claude_usage()\ndata = parse_usage(output)\n\nwith open('/tmp/claude-usage-cache.json', 'w') as f:\n    json.dump(data, f, indent=2)\n\nprint(f\"Captured Claude usage: Session {data['session']['percentUsed']}%, Week {data['weekAll']['percentUsed']}%\")\n```\n\n### Alternative: OpenClaw PTY Tool\n\nIf you're running in OpenClaw, use the PTY execution mode:\n\n```bash\n# OpenClaw exec with pty=true\nexec(command='claude --dangerously-skip-permissions', pty=true, timeout=10)\n\n# Then parse the output and write to cache\n```\n\n### Cache File Format\n\n```json\n{\n  \"session\": { \"percentUsed\": 42, \"resetsAt\": \"5:00 PM EST\" },\n  \"weekAll\": { \"percentUsed\": 38, \"resetsAt\": \"Monday 2/3\" },\n  \"weekSonnet\": { \"percentUsed\": 12, \"resetsAt\": \"Thursday 2/6\" },\n  \"extra\": {\n    \"percentUsed\": 10,\n    \"spent\": 10.54,\n    \"limit\": 100.00,\n    \"resetsAt\": \"Mar 1 (America/New_York)\"\n  },\n  \"capturedAt\": \"2026-02-03T12:00:00.000Z\"\n}\n```\n\n### Cron Setup (Alternative)\n\nIf you prefer a cron job instead of heartbeat:\n\n```bash\n# Add to crontab (every 10 minutes)\n*/10 * * * * /path/to/capture-claude-usage.py >> /tmp/claude-capture.log 2>&1\n```",
    "verification": {
      "type": "file_exists",
      "target": "/tmp/claude-usage-cache.json"
    },
    "idempotent": true,
    "estimated_time": "5 minutes"
  },
  "fetch": {
    "type": "cache_file",
    "cache_path": "/tmp/claude-usage-cache.json"
  }
}