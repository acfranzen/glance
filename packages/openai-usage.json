{
  "version": 1,
  "type": "glance-widget",
  "meta": {
    "name": "OpenAI Usage",
    "slug": "openai-usage",
    "description": "Displays OpenAI API usage statistics - tokens, requests, and costs from the Organization Usage API",
    "author": "zeus@openclaw",
    "created_at": "2026-02-03T16:56:00.000Z",
    "exported_at": "2026-02-03T16:56:00.000Z"
  },
  "widget": {
    "source_code": "function Widget() {\n  const { data, loading, error, refresh } = useData('openai', {});\n\n  const getProgressColor = (percent) => {\n    if (percent > 90) return 'bg-red-500';\n    if (percent > 75) return 'bg-amber-500';\n    if (percent > 50) return 'bg-blue-500';\n    return 'bg-emerald-500';\n  };\n\n  const getProgressVariant = (percent) => {\n    if (percent > 90) return 'error';\n    if (percent > 75) return 'warning';\n    return 'default';\n  };\n\n  const formatNumber = (num) => {\n    if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;\n    if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;\n    return num.toString();\n  };\n\n  const formatCost = (cost) => {\n    if (cost === null || cost === undefined) return '—';\n    return `$${cost.toFixed(2)}`;\n  };\n\n  const formatTimestamp = (isoString) => {\n    try {\n      const date = new Date(isoString);\n      const now = new Date();\n      const diffMs = now.getTime() - date.getTime();\n      const diffMins = Math.floor(diffMs / 60000);\n\n      if (diffMins < 1) return 'just now';\n      if (diffMins < 60) return `${diffMins}m ago`;\n\n      const diffHours = Math.floor(diffMins / 60);\n      if (diffHours < 24) return `${diffHours}h ago`;\n\n      return date.toLocaleDateString();\n    } catch {\n      return 'unknown';\n    }\n  };\n\n  if (loading) {\n    return (\n      <Card className=\"h-full\">\n        <CardContent className=\"flex items-center justify-center h-full\">\n          <Loading message=\"Loading usage...\" />\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (error || data?.error) {\n    return (\n      <Card className=\"h-full\">\n        <CardContent className=\"flex flex-col items-center justify-center h-full gap-3 p-4\">\n          <Icons.AlertCircle className=\"w-8 h-8 text-amber-500\" />\n          <div className=\"text-sm text-center text-muted-foreground\">\n            {error?.message || data?.error || 'Failed to load usage data'}\n          </div>\n          <button\n            onClick={refresh}\n            className=\"text-xs text-primary hover:underline flex items-center gap-1\"\n          >\n            <Icons.RefreshCw className=\"w-3 h-3\" /> Retry\n          </button>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (!data) {\n    return (\n      <Card className=\"h-full\">\n        <CardContent className=\"flex items-center justify-center h-full\">\n          <span className=\"text-sm text-muted-foreground\">No data available</span>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const budgetPercent = data.budget?.limit ? Math.min(100, (data.totalCost / data.budget.limit) * 100) : null;\n\n  return (\n    <Card className=\"h-full flex flex-col\">\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Icons.Zap className=\"w-4 h-4 text-green-500\" />\n            <CardTitle className=\"text-sm\">OpenAI</CardTitle>\n          </div>\n          <button\n            onClick={refresh}\n            className=\"text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            <Icons.RefreshCw className=\"w-3 h-3\" />\n          </button>\n        </div>\n      </CardHeader>\n      <CardContent className=\"flex-1 overflow-y-auto pt-0 space-y-4\">\n        {/* Cost this month */}\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Cost (This Month)</span>\n            <span className=\"text-xs font-semibold text-foreground\">\n              {formatCost(data.totalCost)}\n            </span>\n          </div>\n          {budgetPercent !== null && (\n            <>\n              <Progress value={budgetPercent} variant={getProgressVariant(budgetPercent)} size=\"sm\" />\n              <div className=\"text-[10px] text-muted-foreground\">\n                {formatCost(data.totalCost)} / {formatCost(data.budget.limit)} budget\n              </div>\n            </>\n          )}\n        </div>\n\n        {/* Today's usage */}\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-1\">\n              <Icons.Clock className=\"w-3 h-3 text-muted-foreground\" />\n              <span className=\"text-xs text-muted-foreground\">Today</span>\n            </div>\n            <span className=\"text-xs font-semibold text-foreground\">\n              {formatCost(data.today?.cost)}\n            </span>\n          </div>\n          <div className=\"text-[10px] text-muted-foreground\">\n            {formatNumber(data.today?.totalTokens || 0)} tokens · {formatNumber(data.today?.requests || 0)} requests\n          </div>\n        </div>\n\n        {/* This week */}\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">This Week</span>\n            <span className=\"text-xs font-semibold text-foreground\">\n              {formatCost(data.week?.cost)}\n            </span>\n          </div>\n          <div className=\"text-[10px] text-muted-foreground\">\n            {formatNumber(data.week?.totalTokens || 0)} tokens · {formatNumber(data.week?.requests || 0)} requests\n          </div>\n        </div>\n\n        {/* Top models breakdown */}\n        {data.topModels && data.topModels.length > 0 && (\n          <div className=\"space-y-1 pt-2 border-t border-border/50\">\n            <span className=\"text-xs text-muted-foreground\">Top Models (Month)</span>\n            {data.topModels.slice(0, 3).map((model, i) => (\n              <div key={i} className=\"flex items-center justify-between\">\n                <span className=\"text-[10px] text-muted-foreground truncate max-w-[120px]\">\n                  {model.name}\n                </span>\n                <span className=\"text-[10px] font-medium text-foreground\">\n                  {formatCost(model.cost)}\n                </span>\n              </div>\n            ))}\n          </div>\n        )}\n      </CardContent>\n\n      {/* Last updated timestamp */}\n      <div className=\"text-[10px] text-muted-foreground/60 text-center p-2\">\n        Updated {formatTimestamp(data.fetchedAt)}\n      </div>\n    </Card>\n  );\n}",
    "server_code": "// Fetch OpenAI usage data from the Organization Usage & Costs API\n// Requires an Admin API Key (not a regular API key)\nconst token = await getCredential('openai_admin');\n\nif (!token) {\n  return {\n    error: 'OpenAI Admin API key not configured. Go to platform.openai.com/settings/organization/admin-keys to create one.',\n    fetchedAt: new Date().toISOString()\n  };\n}\n\nconst BASE_URL = 'https://api.openai.com/v1/organization';\n\n// Calculate time ranges\nconst now = new Date();\nconst startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());\nconst startOfWeek = new Date(startOfDay);\nstartOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay()); // Sunday\nconst startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n\nconst todayStart = Math.floor(startOfDay.getTime() / 1000);\nconst weekStart = Math.floor(startOfWeek.getTime() / 1000);\nconst monthStart = Math.floor(startOfMonth.getTime() / 1000);\nconst nowTs = Math.floor(now.getTime() / 1000);\n\nconst headers = {\n  'Authorization': `Bearer ${token}`,\n  'Content-Type': 'application/json'\n};\n\ntry {\n  // Fetch costs for this month (most accurate for billing)\n  const costsResponse = await fetch(\n    `${BASE_URL}/costs?start_time=${monthStart}&end_time=${nowTs}&limit=31&bucket_width=1d`,\n    { headers }\n  );\n  \n  if (!costsResponse.ok) {\n    const errText = await costsResponse.text();\n    if (costsResponse.status === 401 || costsResponse.status === 403) {\n      return {\n        error: 'Invalid Admin API key or insufficient permissions. Ensure you have an Admin key from platform.openai.com/settings/organization/admin-keys',\n        fetchedAt: new Date().toISOString()\n      };\n    }\n    return {\n      error: `OpenAI API error (${costsResponse.status}): ${errText.slice(0, 100)}`,\n      fetchedAt: new Date().toISOString()\n    };\n  }\n  \n  const costsData = await costsResponse.json();\n  \n  // Fetch completions usage with model breakdown for this month\n  const usageResponse = await fetch(\n    `${BASE_URL}/usage/completions?start_time=${monthStart}&end_time=${nowTs}&limit=31&bucket_width=1d&group_by=model`,\n    { headers }\n  );\n  \n  let usageData = { data: [] };\n  if (usageResponse.ok) {\n    usageData = await usageResponse.json();\n  }\n  \n  // Process costs data\n  let totalCost = 0;\n  let todayCost = 0;\n  let weekCost = 0;\n  const modelCosts = {};\n  \n  for (const bucket of (costsData.data || [])) {\n    for (const result of (bucket.results || [])) {\n      const cost = result.amount?.value || 0;\n      totalCost += cost;\n      \n      // Check if this bucket is today\n      if (bucket.start_time >= todayStart) {\n        todayCost += cost;\n      }\n      // Check if this bucket is this week\n      if (bucket.start_time >= weekStart) {\n        weekCost += cost;\n      }\n      \n      // Track by line item (usually model-related)\n      const lineItem = result.line_item || 'unknown';\n      modelCosts[lineItem] = (modelCosts[lineItem] || 0) + cost;\n    }\n  }\n  \n  // Process usage data for tokens and requests\n  let todayTokens = 0, todayRequests = 0;\n  let weekTokens = 0, weekRequests = 0;\n  let monthTokens = 0, monthRequests = 0;\n  const modelUsage = {};\n  \n  for (const bucket of (usageData.data || [])) {\n    for (const result of (bucket.results || [])) {\n      const tokens = (result.input_tokens || 0) + (result.output_tokens || 0);\n      const requests = result.num_model_requests || 0;\n      const model = result.model || 'unknown';\n      \n      monthTokens += tokens;\n      monthRequests += requests;\n      \n      if (bucket.start_time >= todayStart) {\n        todayTokens += tokens;\n        todayRequests += requests;\n      }\n      if (bucket.start_time >= weekStart) {\n        weekTokens += tokens;\n        weekRequests += requests;\n      }\n      \n      if (!modelUsage[model]) {\n        modelUsage[model] = { tokens: 0, requests: 0 };\n      }\n      modelUsage[model].tokens += tokens;\n      modelUsage[model].requests += requests;\n    }\n  }\n  \n  // Build top models list (by cost where available, else by tokens)\n  const topModels = Object.entries(modelCosts)\n    .map(([name, cost]) => ({ name: name.replace(/-\\d{4}-\\d{2}-\\d{2}$/, ''), cost }))\n    .sort((a, b) => b.cost - a.cost)\n    .slice(0, 5);\n  \n  // If no cost data, use usage data for model breakdown\n  if (topModels.length === 0) {\n    const usageModels = Object.entries(modelUsage)\n      .map(([name, usage]) => ({ name: name.replace(/-\\d{4}-\\d{2}-\\d{2}$/, ''), tokens: usage.tokens, requests: usage.requests, cost: null }))\n      .sort((a, b) => b.tokens - a.tokens)\n      .slice(0, 5);\n    topModels.push(...usageModels);\n  }\n  \n  return {\n    totalCost,\n    today: {\n      cost: todayCost,\n      totalTokens: todayTokens,\n      requests: todayRequests\n    },\n    week: {\n      cost: weekCost,\n      totalTokens: weekTokens,\n      requests: weekRequests\n    },\n    month: {\n      cost: totalCost,\n      totalTokens: monthTokens,\n      requests: monthRequests\n    },\n    topModels,\n    budget: null, // OpenAI doesn't expose budget via API; would need manual config\n    fetchedAt: new Date().toISOString()\n  };\n  \n} catch (err) {\n  return {\n    error: `Failed to fetch OpenAI usage: ${err.message}`,\n    fetchedAt: new Date().toISOString()\n  };\n}",
    "server_code_enabled": true,
    "default_size": { "w": 1, "h": 2 },
    "min_size": { "w": 1, "h": 1 },
    "refresh_interval": 300
  },
  "credentials": [
    {
      "id": "openai_admin",
      "type": "api_key",
      "name": "OpenAI Admin API Key",
      "description": "An Admin API key for your OpenAI organization. This is different from regular API keys - Admin keys have access to organization-level endpoints including usage and billing data.",
      "obtain_url": "https://platform.openai.com/settings/organization/admin-keys",
      "validation_endpoint": "https://api.openai.com/v1/organization/users?limit=1"
    }
  ],
  "setup": null,
  "fetch": {
    "type": "server_code"
  }
}
